DROP TABLE IF EXISTS TEST.stage_customer_order;
DROP TABLE IF EXISTS TEST.raw_order;
DROP TABLE IF EXISTS TEST.raw_customer;
GO

-- Raw table 1: Customers
CREATE TABLE TEST.raw_customer (
    customer_id INT,
    first_name   VARCHAR(50),
    last_name    VARCHAR(50),
    email        VARCHAR(100),
    city         VARCHAR(50),
    updated_at   DATETIME,

    inserted_at  DATETIME NOT NULL
        CONSTRAINT DF_raw_customer_inserted_at DEFAULT SYSDATETIME()
);
GO

-- Raw table 2: Orders
CREATE TABLE TEST.raw_order (
    order_id     INT,
    customer_id  INT,
    order_date   DATE,
    amount       DECIMAL(10,2),
    status       VARCHAR(20),
    updated_at   DATETIME,

    inserted_at  DATETIME NOT NULL
        CONSTRAINT DF_raw_order_inserted_at DEFAULT SYSDATETIME()
);
GO

-- Customers (initial)
INSERT INTO TEST.raw_customer (customer_id, first_name, last_name, email, city, updated_at)
VALUES
(1, 'Rohit', 'Sharma', 'rohit@test.com', 'Hyderabad', '2026-02-01'),
(2, 'Ravi',  'Kumar',  'ravi@test.com',  'Bangalore', '2026-02-01');

-- Orders (initial)
INSERT INTO TEST.raw_order (order_id, customer_id, order_date, amount, status, updated_at)
VALUES
(101, 1, '2026-02-10', 1500.00, 'NEW', '2026-02-10'),
(102, 2, '2026-02-11', 2200.00, 'NEW', '2026-02-11');


CREATE TABLE TEST.stage_customer_order (
    customer_id INT,
    order_id    INT,
    full_name   VARCHAR(120),
    email       VARCHAR(100),
    city        VARCHAR(50),
    order_date  DATE,
    amount      DECIMAL(10,2),
    status      VARCHAR(20),
    last_update DATETIME,

    customer_inserted_at DATETIME NOT NULL,
    order_inserted_at    DATETIME NOT NULL,

    row_hash VARBINARY(32),

    CONSTRAINT PK_stage_customer_order PRIMARY KEY (customer_id, order_id)
);
GO



CREATE OR ALTER PROCEDURE TEST.usp_load_stage_customer_order_delta
AS
BEGIN
    SET NOCOUNT ON;

    DECLARE @last_customer_inserted_at DATETIME;
    DECLARE @last_order_inserted_at    DATETIME;

    SELECT
        @last_customer_inserted_at = MAX(customer_inserted_at),
        @last_order_inserted_at    = MAX(order_inserted_at)
    FROM TEST.stage_customer_order;

    SET @last_customer_inserted_at = ISNULL(@last_customer_inserted_at, '1900-01-01');
    SET @last_order_inserted_at    = ISNULL(@last_order_inserted_at, '1900-01-01');

    MERGE TEST.stage_customer_order AS tgt
    USING (
        SELECT
            c.customer_id,
            o.order_id,
            c.first_name + ' ' + c.last_name AS full_name,
            c.email,
            c.city,
            o.order_date,
            o.amount,
            o.status,
            CASE 
                WHEN c.updated_at > o.updated_at THEN c.updated_at 
                ELSE o.updated_at 
            END AS last_update,

            c.inserted_at AS customer_inserted_at,
            o.inserted_at AS order_inserted_at,

            HASHBYTES(
                'SHA2_256',
                CONCAT(
                    c.first_name, '|', c.last_name, '|', c.email, '|', c.city, '|',
                    o.order_date, '|', o.amount, '|', o.status
                )
            ) AS row_hash
        FROM TEST.raw_customer c
        JOIN TEST.raw_order o
            ON c.customer_id = o.customer_id
        WHERE
            c.inserted_at > @last_customer_inserted_at
         OR o.inserted_at > @last_order_inserted_at
    ) AS src
    ON (tgt.customer_id = src.customer_id AND tgt.order_id = src.order_id)

    WHEN MATCHED 
         AND tgt.row_hash <> src.row_hash THEN
        UPDATE SET
            tgt.full_name              = src.full_name,
            tgt.email                  = src.email,
            tgt.city                   = src.city,
            tgt.order_date             = src.order_date,
            tgt.amount                 = src.amount,
            tgt.status                 = src.status,
            tgt.last_update            = src.last_update,
            tgt.customer_inserted_at   = src.customer_inserted_at,
            tgt.order_inserted_at      = src.order_inserted_at,
            tgt.row_hash               = src.row_hash

    WHEN NOT MATCHED BY TARGET THEN
        INSERT (
            customer_id,
            order_id,
            full_name,
            email,
            city,
            order_date,
            amount,
            status,
            last_update,
            customer_inserted_at,
            order_inserted_at,
            row_hash
        )
        VALUES (
            src.customer_id,
            src.order_id,
            src.full_name,
            src.email,
            src.city,
            src.order_date,
            src.amount,
            src.status,
            src.last_update,
            src.customer_inserted_at,
            src.order_inserted_at,
            src.row_hash
        );

END;
GO


EXEC dbo.usp_load_stage_customer_order;



| Step             | Logic                                                               |
| ---------------- | ------------------------------------------------------------------- |
| Watermark Read   | MAX(customer_inserted_at), MAX(order_inserted_at) from stage        |
| Delta Filter     | c.inserted_at > last_customer_wm OR o.inserted_at > last_order_wm   |
| Change Detection | Compare row_hash between source and stage                           |
| New Row          | WHEN NOT MATCHED → INSERT                                           |
| Changed Row      | WHEN MATCHED AND hash <> → UPDATE                                   |
| Duplicate        | Same hash → Ignored                                                 |


-- New customer
INSERT INTO TEST.raw_customer (customer_id, first_name, last_name, email, city, updated_at)
VALUES
(3, 'Virat', 'Kohli', 'virat@test.com', 'Delhi', '2026-02-12');

-- New order
INSERT INTO TEST.raw_order (order_id, customer_id, order_date, amount, status, updated_at)
VALUES
(103, 3, '2026-02-12', 3000.00, 'NEW', '2026-02-12');


-- Updated customer 1 (city changed)
INSERT INTO TEST.raw_customer (customer_id, first_name, last_name, email, city, updated_at)
VALUES
(1, 'Rohit', 'Sharma', 'rohit@test.com', 'Mumbai', '2026-02-15');

-- Updated order 101 (amount & status changed)
INSERT INTO TEST.raw_order (order_id, customer_id, order_date, amount, status, updated_at)
VALUES
(101, 1, '2026-02-10', 1800.00, 'PAID', '2026-02-15');


-- Customers (initial)
INSERT INTO TEST.raw_customer (customer_id, first_name, last_name, email, city, updated_at)
VALUES
(1, 'Rohit', 'Sharma', 'rohit@test.com', 'Hyderabad', '2026-02-01'),
(2, 'Ravi',  'Kumar',  'ravi@test.com',  'Bangalore', '2026-02-01');

-- Orders (initial)
INSERT INTO TEST.raw_order (order_id, customer_id, order_date, amount, status, updated_at)
VALUES
(101, 1, '2026-02-10', 1500.00, 'NEW', '2026-02-10'),
(102, 2, '2026-02-11', 2200.00, 'NEW', '2026-02-11');

